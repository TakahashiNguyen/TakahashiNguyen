<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />

		<style>
			body {
				margin: 0;
				overflow: hidden;
				width: 100dvw;
				height: 100dvh;
			}
			canvas {
				display: block;
			}
		</style>

		<script type="text/javascript" src="../.js/utils.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
	</head>
	<body id="body">
		<script>
			(async () => {
				class App extends GLSLElement {
					constructor(element) {
						super(element);
					}

					async start() {
						this.bufferA = await this.initBuffer(
							false,
							"../.frag/VHS/a.frag",
							"../.frag/VHS/_common.frag",
							this.mainChannel
						);
						this.bufferB = await this.initBuffer(false, "../.frag/VHS/b.frag", "../.frag/VHS/_common.frag");
						this.bufferC = await this.initBuffer(false, "../.frag/VHS/c.frag", "../.frag/VHS/_common.frag");
						this.bufferD = await this.initBuffer(false, "../.frag/VHS/d.frag", "../.frag/VHS/_common.frag");
						this.bufferImage = await this.initBuffer(
							true,
							"../.frag/VHS/_main.frag",
							"../.frag/VHS/_common.frag",
							null,
							this.mainChannel
						);

						this.animate();
					}

					animate() {
						requestAnimationFrame(async () => {
							// bufferB section
							this.bufferB.setChannel(0, this.bufferA);

							// bufferC section
							this.bufferC.setChannel(0, this.bufferC);
							this.bufferC.setChannel(1, this.bufferB);

							// bufferD section
							this.bufferD.setChannel(0, this.bufferC);

							// bufferImage section
							this.bufferImage.setChannel(0, this.bufferD);

							// Render section
							this.bufferA.render();
							this.bufferB.render();
							this.bufferC.render();
							this.bufferD.render();
							this.bufferImage.render();

							this.setDOMSize();
							this.animate();
							this.mainChannel.needsUpdate = true;
						});
					}
				}

				document.addEventListener("DOMContentLoaded", async () => {
					new App("videoChannel");
					//new App("imageChannel");
				});
			})();
		</script>

		<div style="position: relative; display: flex; flex-direction: column">
			<video
				id="videoChannel"
				autoplay
				loop
				muted
				src="../.webm/greenScreenMan.webm"
				style="width: 100%; display: block"
			></video>
			<img src="../.jpg/ISS.jpg" alt="" width="100%" height="500" id="imageChannel" />
		</div>
	</body>
</html>
